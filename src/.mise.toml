[settings]
# bash ã‚’ç”¨ã„ã¦å¯¾è©±çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’è¨±å¯
idiomatic_version_file_enable_tools = ["bash"]

# ===== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚¿ã‚¹ã‚¯ =====

# æ–°è¦ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
# - local/é…ä¸‹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
# - gitåˆæœŸåŒ–ã€Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# - tmuxinatorè¨­å®šç”Ÿæˆï¼†ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
[tasks.new]
description = "Create a new project directory, init git, optional Python venv, generate tmuxinator config, and start session"
shell = "bash -lc"
run = ['''
read -p "ğŸ†• Project name: " name && \
read -p "ğŸ“ Project description: " description && \
base=$(ghq root)/local/$name && \
mkdir -p "$base" && \
cd "$base" && \
git init && \
read -p "Is this a Python project? (y/N): " is_py && \
if [[ "$is_py" =~ ^[Yy]$ ]]; then \
  uv venv; \
fi && \
mise_root_dir="$(ghq root)" && \
template_dir="$mise_root_dir/templates" && \
template_path="$template_dir/README.md.template" && \
if [ -f "$template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$template_path" > README.md; \
else \
  echo "# $name" > README.md && echo "" >> README.md && echo "## Description" >> README.md && echo "" >> README.md && echo "TODO: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„" >> README.md; \
fi && \
env_template_path="$template_dir/.env.template" && \
if [ -f "$env_template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$env_template_path" > .env; \
fi && \
envrc_template_path="$template_dir/.envrc.template" && \
if [ -f "$envrc_template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$envrc_template_path" > .envrc; \
fi && \
echo "$description" > .description && \
gitignore_template_path="$template_dir/.gitignore.template" && \
if [ -f "$gitignore_template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$gitignore_template_path" > .gitignore; \
fi && \
devcontainer_template_dir="$template_dir/.devcontainer" && \
if [ -d "$devcontainer_template_dir" ]; then \
  cp -rp "$devcontainer_template_dir" .; \
  chmod +x .devcontainer/launch.sh 2>/dev/null || true; \
  if [ -f ".devcontainer/devcontainer.json" ]; then \
    sed -i.bak "s|\"runArgs\": \\[|\"runArgs\": [\\n    \"--name=project-$name-container\",|" .devcontainer/devcontainer.json && \
    rm .devcontainer/devcontainer.json.bak; \
    echo "âœ… Updated devcontainer.json with project-specific container name"; \
  fi; \
  echo "âœ… Copied .devcontainer configuration"; \
else \
  echo "âš ï¸  .devcontainer template not found: $devcontainer_template_dir"; \
fi && \
claude_template_dir="$template_dir/claude" && \
if [ -d "$claude_template_dir" ]; then \
  claude_md_template="$claude_template_dir/CLAUDE.md" && \
  if [ -f "$claude_md_template" ]; then \
    cp "$claude_md_template" CLAUDE.md; \
    echo "âœ… Copied CLAUDE.md"; \
  fi && \
  mkdir -p .claude/tasks && \
  task_template="$claude_template_dir/task_template.md" && \
  if [ -f "$task_template" ]; then \
    cp "$task_template" .claude/tasks/; \
    echo "âœ… Copied task_template.md to .claude/tasks/"; \
  fi && \
  order_template="$claude_template_dir/order.md" && \
  if [ -f "$order_template" ]; then \
    cp "$order_template" .claude/; \
    echo "âœ… Copied order.md to .claude/"; \
  fi && \
  settings_template="$claude_template_dir/settings.json" && \
  if [ -f "$settings_template" ]; then \
    cp "$settings_template" .claude/; \
    echo "âœ… Copied settings.json to .claude/"; \
  fi && \
  mcp_template="$claude_template_dir/.mcp.json" && \
  if [ -f "$mcp_template" ]; then \
    cp "$mcp_template" .mcp.json; \
    echo "âœ… Copied .mcp.json"; \
  fi; \
else \
  echo "âš ï¸  claude template not found: $claude_template_dir"; \
fi && \
tmux_template_path="$template_dir/tmuxinator.yml.template" && \
if [ -f "$tmux_template_path" ]; then \
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator" && sed -e "s/PROJECT_NAME/$name/g" -e "s|PROJECT_ROOT|$base|g" "$tmux_template_path" > "${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$name.yml"; \
else \
  echo "âš ï¸  tmuxinator template not found: $tmux_template_path"; \
fi

echo "âœ… Project '$name' created successfully!"
echo "ğŸ“ Location: $base"
echo "ğŸ”§ Tmuxinator config: ${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$name.yml"
echo ""
echo "ğŸš€ To start working on this project, run:"
echo "   mise enter"
''']

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’GitHubã«å…¬é–‹
# - local/é…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
# - GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆï¼ˆpublic/privateé¸æŠå¯èƒ½ï¼‰
# - github.com/é…ä¸‹ã«è‡ªå‹•ç§»å‹•
# - tmuxinatorè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹æ›´æ–°
[tasks.publish]
description = "Select a local project and publish it to GitHub"
shell = "bash -lc"
run = ['''
# localé…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
local_projects=$(find $(ghq root)/local -maxdepth 1 -type d -name "*" | sed "s|$(ghq root)/local/||" | grep -v "^$")
if [ -z "$local_projects" ]; then
  echo "âŒ No local projects found"
  exit 1
fi

selected=$(echo "$local_projects" | fzf --prompt="ğŸ“¦ Select local project to publish: ")
if [ -z "$selected" ]; then
  echo "âŒ No project selected"
  exit 1
fi

project_path=$(ghq root)/local/$selected
cd "$project_path"

# GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
read -p "ğŸ”— GitHub repository name (default: $selected): " repo_name
repo_name=${repo_name:-$selected}

# .descriptionãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª¬æ˜ã‚’å–å¾—
if [ -f ".description" ]; then
  auto_description=$(cat .description)
  echo "ğŸ“ Auto-detected description: $auto_description"
  read -p "ğŸ“ Use this description? (Y/n): " use_auto_desc
  if [[ "$use_auto_desc" =~ ^[Nn]$ ]]; then
    read -p "ğŸ“ Repository description: " description
  else
    description="$auto_description"
  fi
else
  read -p "ğŸ“ Repository description: " description
fi

read -p "ğŸ”“ Make repository public? (y/N): " is_public

if [[ "$is_public" =~ ^[Yy]$ ]]; then
  visibility="--public"
else
  visibility="--private"
fi

# GitHub CLIã§ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
gh repo create "$repo_name" $visibility --description "$description" --source=. --remote=origin

# .descriptionãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆGitHubã«pushã—ãªã„ï¼‰
if [ -f ".description" ]; then
  echo "ğŸ—‘ï¸  Removing .description file before push..."
  rm .description
  git add .description 2>/dev/null || true
  git commit -m "Remove .description file before GitHub publish" || true
fi

# GitHubã«push
echo "ğŸ“¤ Pushing to GitHub..."
git push origin main

# README.mdã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯ã‚’èª­ã¿å–ã£ã¦GitHub Topicsã‚’è¨­å®š
if [ -f "README.md" ]; then
  echo "ğŸ·ï¸  Reading topics from README.md..."
  topics=$(sed -n '/^## Topics/,/^## /p' README.md | grep '^- ' | sed 's/^- //' | grep -v '^$')
  if [ -n "$topics" ]; then
    topic_args=""
    echo "$topics" | while read -r topic; do
      if [ -n "$topic" ]; then
        echo "ğŸ·ï¸  Adding topic: $topic"
        gh repo edit --add-topic "$topic"
      fi
    done
  else
    echo "â„¹ï¸  No topics found in README.md Topics section"
  fi
else
  echo "âš ï¸  README.md not found, skipping topic setup"
fi

# GitHubä¸Šã®ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’å–å¾—
github_user=$(gh api user --jq .login)
github_url="https://github.com/$github_user/$repo_name"

# ghqç®¡ç†ä¸‹ã®github.comãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
github_path=$(ghq root)/github.com/$github_user/$repo_name
mkdir -p "$(dirname "$github_path")"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç§»å‹•
echo "ğŸ“¦ Moving project to GitHub directory..."
mv "$project_path" "$github_path"

# tmuxinatorè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æ›´æ–°
tmux_config="${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$selected.yml"
if [ -f "$tmux_config" ]; then
  echo "ğŸ”§ Updating tmuxinator configuration..."
  sed -i.bak "s|root: .*|root: $github_path|" "$tmux_config"
  rm "$tmux_config.bak"
fi

echo "âœ… Repository published to GitHub: $github_url"
echo "ğŸ“ Project moved to: $github_path"
echo "ğŸ”§ Tmuxinator config updated"
echo "ğŸ”— You can now use 'mise enter' to work on this project"
''']

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
# - ghqç®¡ç†ä¸‹ã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºï¼ˆlocal/ã€github.com/ä¸¡æ–¹å«ã‚€ï¼‰
# - é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨tmuxinatorè¨­å®šã‚’å‰Šé™¤
# - è©³ç´°æƒ…å ±è¡¨ç¤ºå¾Œã€ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»˜ãã§å®‰å…¨ã«å‰Šé™¤
[tasks.delete]
description = "Select and delete a project directory and its tmuxinator config with confirmation"
shell = "bash -lc"
run = ['''
# ghqç®¡ç†ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
projects=$(ghq list)
if [ -z "$projects" ]; then
  echo "âŒ No projects found"
  exit 1
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
selected=$(echo "$projects" | fzf --prompt="ğŸ—‘ï¸  Select project to DELETE: ")
if [ -z "$selected" ]; then
  echo "âŒ No project selected"
  exit 1
fi

project_path=$(ghq root)/$selected
project_name=$(basename "$selected")
readme_path="$project_path/README.md"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è©³ç´°è¡¨ç¤º
echo "ğŸ—‘ï¸  Project Deletion Confirmation"
echo "=================================="
echo "ğŸ“ Project Name: $project_name"
echo "ğŸ“ Directory: $project_path"
echo "ğŸ”§ Tmuxinator Config: ${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$project_name.yml"
echo "ğŸŒ Type: $(dirname "$selected" | sed 's|.*/||')"
echo ""

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹è¡¨ç¤º
if [ -d "$project_path" ]; then
  echo "ğŸ“‹ Directory Contents:"
  ls -la "$project_path" | head -10
  file_count=$(find "$project_path" -type f | wc -l)
  echo "   Total files: $file_count"
  echo ""
fi

# Gitæƒ…å ±è¡¨ç¤º
if [ -d "$project_path/.git" ]; then
  echo "ğŸ“Š Git Information:"
  cd "$project_path"
  commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")
  last_commit=$(git log -1 --format="%ar" 2>/dev/null || echo "æœªã‚³ãƒŸãƒƒãƒˆ")
  echo "   Commits: $commit_count"
  echo "   Last commit: $last_commit"
  
  # æœªã‚³ãƒŸãƒƒãƒˆå¤‰æ›´ç¢ºèª
  if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
    echo "   âš ï¸  Uncommitted changes detected!"
    git status --porcelain
  fi
  echo ""
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
if [[ "$selected" == github.com/* ]]; then
  # GitHubæƒ…å ±ã‚’å–å¾—ãƒ»è¡¨ç¤º
  repo_path="${selected#github.com/}"
  echo "ğŸŒ GitHub Repository Information:"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # GitHubæƒ…å ±ã‚’å–å¾—
  if gh_info=$(gh repo view "$repo_path" --json name,description,url,isPrivate 2>/dev/null); then
    repo_name=$(echo "$gh_info" | jq -r '.name')
    repo_description=$(echo "$gh_info" | jq -r '.description // "No description"')
    repo_url=$(echo "$gh_info" | jq -r '.url')
    is_private=$(echo "$gh_info" | jq -r '.isPrivate')
    
    echo "ğŸ“ Name: $repo_name"
    echo "ğŸ“ Description: $repo_description"
    echo "ğŸ”— URL: $repo_url"
    echo "ğŸ”’ Visibility: $([ "$is_private" = "true" ] && echo "Private" || echo "Public")"
  else
    echo "âš ï¸  GitHubæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
  fi
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
else
  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
  echo "ğŸ’» Local Project Information:"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # .descriptionãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª¬æ˜ã‚’å–å¾—
  description_file="$project_path/.description"
  if [ -f "$description_file" ]; then
    local_description=$(cat "$description_file")
    echo "ğŸ“ Description: $local_description"
  else
    echo "ğŸ“ Description: No description available"
  fi
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
fi

echo "âš ï¸  WARNING: This action cannot be undone!"
echo "To confirm deletion, type 'DELETE' (all uppercase):"
read -r confirmation

if [ "$confirmation" != "DELETE" ]; then
  echo "âŒ Deletion cancelled."
  exit 0
fi

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
if [ -d "$project_path" ]; then
  rm -rf "$project_path"
  echo "âœ… Deleted directory: $project_path"
else
  echo "âš ï¸  Directory not found: $project_path"
fi

# tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
if tmux has-session -t "$project_name" 2>/dev/null; then
  tmux kill-session -t "$project_name"
  echo "âœ… Killed tmux session: $project_name"
else
  echo "â„¹ï¸  No active tmux session: $project_name"
fi

# tmuxinatorè¨­å®šå‰Šé™¤
tmux_config="${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$project_name.yml"
if [ -f "$tmux_config" ]; then
  rm "$tmux_config"
  echo "âœ… Deleted tmuxinator config: $tmux_config"
else
  echo "âš ï¸  Tmuxinator config not found: $tmux_config"
fi

echo "ğŸ—‘ï¸  Project '$project_name' has been completely removed"
''']

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¨è©³ç´°è¡¨ç¤º
# - ghqç®¡ç†ä¸‹ã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºï¼ˆlocal/ã€github.com/ä¸¡æ–¹å«ã‚€ï¼‰
# - é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®README.mdã‹ã‚‰Descriptionéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
# - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬æƒ…å ±ã‚‚ä½µã›ã¦è¡¨ç¤º
[tasks.info]
description = "List projects and show details of selected project"
shell = "bash -lc"
run = ['''
# ghqç®¡ç†ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
projects=$(ghq list)
if [ -z "$projects" ]; then
  echo "âŒ No projects found"
  exit 1
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
selected=$(echo "$projects" | fzf --prompt="ğŸ“‚ Select project to view details: ")
if [ -z "$selected" ]; then
  echo "âŒ No project selected"
  exit 1
fi

project_path=$(ghq root)/$selected
project_name=$(basename "$selected")
readme_path="$project_path/README.md"

echo "ğŸ“‚ Project: $project_name"
echo "ğŸ“ Location: $project_path"
echo "ğŸŒ Type: $(dirname "$selected" | sed 's|.*/||')"
echo ""

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
if [[ "$selected" == github.com/* ]]; then
  # GitHubæƒ…å ±ã‚’å–å¾—ãƒ»è¡¨ç¤º
  repo_path="${selected#github.com/}"
  echo "ğŸŒ GitHub Repository Information:"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # GitHubæƒ…å ±ã‚’å–å¾—
  if gh_info=$(gh repo view "$repo_path" --json name,description,url,isPrivate 2>/dev/null); then
    repo_name=$(echo "$gh_info" | jq -r '.name')
    repo_description=$(echo "$gh_info" | jq -r '.description // "No description"')
    repo_url=$(echo "$gh_info" | jq -r '.url')
    is_private=$(echo "$gh_info" | jq -r '.isPrivate')
    
    echo "ğŸ“ Name: $repo_name"
    echo "ğŸ“ Description: $repo_description"
    echo "ğŸ”— URL: $repo_url"
    echo "ğŸ”’ Visibility: $([ "$is_private" = "true" ] && echo "Private" || echo "Public")"
  else
    echo "âš ï¸  GitHubæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
  fi
  
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
else
  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
  echo "ğŸ’» Local Project Information:"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # .descriptionãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª¬æ˜ã‚’å–å¾—
  description_file="$project_path/.description"
  if [ -f "$description_file" ]; then
    local_description=$(cat "$description_file")
    echo "ğŸ“ Description: $local_description"
  else
    echo "ğŸ“ Description: No description available"
  fi
  
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
fi

# ãƒ­ãƒ¼ã‚«ãƒ«Gitçµ±è¨ˆ
if [ -d "$project_path/.git" ]; then
  cd "$project_path"
  commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")
  last_commit=$(git log -1 --format="%ar" 2>/dev/null || echo "æœªã‚³ãƒŸãƒƒãƒˆ")
  echo "ğŸ“Š Gitçµ±è¨ˆ:"
  echo "   ã‚³ãƒŸãƒƒãƒˆæ•°: $commit_count"
  echo "   æœ€çµ‚æ›´æ–°: $last_commit"
fi
''']

# æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
# - GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ghqç®¡ç†ä¸‹ã«ã‚¯ãƒ­ãƒ¼ãƒ³
# - tmuxinatorè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•ç”Ÿæˆ
# - GitHubæƒ…å ±ã®å–å¾—ã¨ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®š
[tasks.clone]
description = "Clone an existing repository and set up tmuxinator config"
shell = "bash -lc"
run = ['''
# Git URLã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
read -p "ğŸ”— Git repository URL: " git_url

if [ -z "$git_url" ]; then
  echo "âŒ Git URL is required"
  echo "Examples:"
  echo "  SSH: git@github.com:user/repo.git or git@github.com:user/repo"
  echo "  HTTPS: https://github.com/user/repo or https://github.com/user/repo.git"
  exit 1
fi

# GitHubãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’æŠ½å‡º
if [[ "$git_url" =~ git@github\.com:([^/]+)/([^\.]+)(\.git)?$ ]]; then
  github_user="${BASH_REMATCH[1]}"
  repo_name="${BASH_REMATCH[2]}"
elif [[ "$git_url" =~ https://github\.com/([^/]+)/([^/\.]+)(\.git)?/?$ ]]; then
  github_user="${BASH_REMATCH[1]}"
  repo_name="${BASH_REMATCH[2]}"
else
  echo "âŒ Invalid GitHub URL format"
  echo "Received: $git_url"
  echo "Supported formats:"
  echo "  SSH: git@github.com:user/repo.git or git@github.com:user/repo"
  echo "  HTTPS: https://github.com/user/repo or https://github.com/user/repo.git"
  exit 1
fi

echo "ğŸ“¦ Cloning repository: $github_user/$repo_name"

# ghqã§ã‚¯ãƒ­ãƒ¼ãƒ³
if ! ghq get "$git_url"; then
  echo "âŒ Failed to clone repository"
  exit 1
fi

# ã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
repo_path=$(ghq root)/github.com/$github_user/$repo_name
cd "$repo_path"

# GitHubæƒ…å ±ã‚’å–å¾—ã—ã¦descriptionã‚’è¨­å®š
echo "ğŸŒ Fetching GitHub repository information..."
if gh_info=$(gh repo view "$github_user/$repo_name" --json description 2>/dev/null); then
  gh_description=$(echo "$gh_info" | jq -r '.description // ""')
  if [ -n "$gh_description" ] && [ "$gh_description" != "null" ]; then
    echo "ğŸ“ Found description: $gh_description"
  fi
fi

# tmuxinatorè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨devcontainerã®ç”Ÿæˆ
mise_root_dir="$(ghq root)" && \
template_dir="$mise_root_dir/templates" && \
devcontainer_template_dir="$template_dir/.devcontainer" && \
if [ -d "$devcontainer_template_dir" ]; then \
  if [ -d ".devcontainer" ]; then \
    read -p "âš ï¸  .devcontainer directory already exists. Overwrite? (y/N): " overwrite_devcontainer; \
    if [[ "$overwrite_devcontainer" =~ ^[Yy]$ ]]; then \
      rm -rf .devcontainer; \
      cp -rp "$devcontainer_template_dir" .; \
      chmod +x .devcontainer/launch.sh 2>/dev/null || true; \
      echo "âœ… Overwritten .devcontainer configuration"; \
    else \
      echo "â„¹ï¸  Skipped .devcontainer configuration"; \
    fi; \
  else \
    cp -rp "$devcontainer_template_dir" .; \
    chmod +x .devcontainer/launch.sh 2>/dev/null || true; \
    if [ -f ".devcontainer/devcontainer.json" ]; then \
      sed -i.bak "s|\"runArgs\": \\[|\"runArgs\": [\\n    \"--name=project-$repo_name-container\",|" .devcontainer/devcontainer.json && \
      rm .devcontainer/devcontainer.json.bak; \
      echo "âœ… Updated devcontainer.json with project-specific container name"; \
    fi; \
    echo "âœ… Copied .devcontainer configuration"; \
  fi; \
else \
  echo "âš ï¸  .devcontainer template not found: $devcontainer_template_dir"; \
fi && \
claude_template_dir="$template_dir/claude" && \
if [ -d "$claude_template_dir" ]; then \
  overwrite_claude=false; \
  if [ -f "CLAUDE.md" ]; then \
    read -p "âš ï¸  CLAUDE.md already exists. Overwrite? (y/N): " overwrite_claude_md; \
    if [[ "$overwrite_claude_md" =~ ^[Yy]$ ]]; then \
      overwrite_claude=true; \
    else \
      echo "â„¹ï¸  Skipped CLAUDE.md"; \
    fi; \
  else \
    overwrite_claude=true; \
  fi; \
  if [ "$overwrite_claude" = true ]; then \
    claude_md_template="$claude_template_dir/CLAUDE.md" && \
    if [ -f "$claude_md_template" ]; then \
      cp "$claude_md_template" CLAUDE.md; \
      echo "âœ… Copied CLAUDE.md"; \
    fi; \
  fi; \
  if [ -d ".claude" ]; then \
    read -p "âš ï¸  .claude directory already exists. Overwrite? (y/N): " overwrite_claude_dir; \
    if [[ "$overwrite_claude_dir" =~ ^[Yy]$ ]]; then \
      rm -rf .claude; \
      mkdir -p .claude/tasks; \
      task_template="$claude_template_dir/task_template.md" && \
      if [ -f "$task_template" ]; then \
        cp "$task_template" .claude/tasks/; \
        echo "âœ… Copied task_template.md to .claude/tasks/"; \
      fi; \
      order_template="$claude_template_dir/order.md" && \
      if [ -f "$order_template" ]; then \
        cp "$order_template" .claude/; \
        echo "âœ… Copied order.md to .claude/"; \
      fi; \
      settings_template="$claude_template_dir/settings.json" && \
      if [ -f "$settings_template" ]; then \
        cp "$settings_template" .claude/; \
        echo "âœ… Copied settings.json to .claude/"; \
      fi; \
    else \
      echo "â„¹ï¸  Skipped .claude directory setup"; \
    fi; \
  else \
    mkdir -p .claude/tasks; \
    task_template="$claude_template_dir/task_template.md" && \
    if [ -f "$task_template" ]; then \
      cp "$task_template" .claude/tasks/; \
      echo "âœ… Copied task_template.md to .claude/tasks/"; \
    fi; \
    order_template="$claude_template_dir/order.md" && \
    if [ -f "$order_template" ]; then \
      cp "$order_template" .claude/; \
      echo "âœ… Copied order.md to .claude/"; \
    fi; \
    settings_template="$claude_template_dir/settings.json" && \
    if [ -f "$settings_template" ]; then \
      cp "$settings_template" .claude/; \
      echo "âœ… Copied settings.json to .claude/"; \
    fi && \
    mcp_template="$claude_template_dir/.mcp.json" && \
    if [ -f "$mcp_template" ]; then \
      cp "$mcp_template" .mcp.json; \
      echo "âœ… Copied .mcp.json"; \
    fi; \
  fi; \
else \
  echo "âš ï¸  claude template not found: $claude_template_dir"; \
fi && \
tmux_template_path="$template_dir/tmuxinator.yml.template" && \
if [ -f "$tmux_template_path" ]; then \
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator" && sed -e "s/PROJECT_NAME/$repo_name/g" -e "s|PROJECT_ROOT|$repo_path|g" "$tmux_template_path" > "${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$repo_name.yml"; \
else \
  echo "âš ï¸  tmuxinator template not found: $tmux_template_path"; \
fi

echo "âœ… Repository cloned and configured successfully!"
echo "ğŸ“ Location: $repo_path"
echo "ğŸ”§ Tmuxinator config: ${XDG_CONFIG_HOME:-$HOME/.config}/tmuxinator/$repo_name.yml"
echo ""
echo "ğŸš€ To start working on this project, run:"
echo "   mise enter"
''']

# æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¨ãƒ³ãƒˆãƒª
# - ghqç®¡ç†ä¸‹ã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºï¼ˆlocal/ã€github.com/ä¸¡æ–¹å«ã‚€ï¼‰
# - é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®tmuxinatorã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
[tasks.enter]
description = "Select an existing ghq project via fzf and start its tmuxinator session"
shell = "bash -lc"
run = ['''
repo=$(ghq list | fzf) && \
name=$(basename "$repo") && \
# Start tmuxinator session for selected project
tmuxinator start "$name"
''']
