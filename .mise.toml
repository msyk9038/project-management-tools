[settings]
# bash ã‚’ç”¨ã„ã¦å¯¾è©±çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’è¨±å¯
idiomatic_version_file_enable_tools = ["bash"]

# ===== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚¿ã‚¹ã‚¯ =====

# æ–°è¦ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
# - local/é…ä¸‹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
# - gitåˆæœŸåŒ–ã€Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# - tmuxinatorè¨­å®šç”Ÿæˆï¼†ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
[tasks.new]
description = "Create a new project directory, init git, optional Python venv, generate tmuxinator config, and start session"
shell = "bash -lc"
run = ['''
read -p "ğŸ†• Project name: " name && \
base=$(ghq root)/local/$name && \
mkdir -p "$base" && \
cd "$base" && \
git init && \
read -p "Is this a Python project? (y/N): " is_py && \
if [[ "$is_py" =~ ^[Yy]$ ]]; then \
  uv venv; \
fi && \
mise_root_dir="$(ghq root)" && \
template_dir="$mise_root_dir/templates" && \
template_path="$template_dir/README.md.template" && \
if [ -f "$template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$template_path" > README.md; \
else \
  echo "# $name" > README.md && echo "" >> README.md && echo "## Description" >> README.md && echo "" >> README.md && echo "TODO: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„" >> README.md; \
fi && \
env_template_path="$template_dir/.env.template" && \
if [ -f "$env_template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$env_template_path" > .env; \
fi && \
envrc_template_path="$template_dir/.envrc.template" && \
if [ -f "$envrc_template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$envrc_template_path" > .envrc; \
fi && \
gitignore_template_path="$template_dir/.gitignore.template" && \
if [ -f "$gitignore_template_path" ]; then \
  sed "s/PROJECT_NAME/$name/g" "$gitignore_template_path" > .gitignore; \
fi && \
tmux_template_path="$template_dir/tmuxinator.yml.template" && \
if [ -f "$tmux_template_path" ]; then \
  sed -e "s/PROJECT_NAME/$name/g" -e "s|PROJECT_ROOT|$base|g" "$tmux_template_path" > ~/.tmuxinator/$name.yml; \
else \
  echo "âš ï¸  tmuxinator template not found: $tmux_template_path"; \
fi

echo "âœ… Project '$name' created successfully!"
echo "ğŸ“ Location: $base"
echo "ğŸ”§ Tmuxinator config: ~/.tmuxinator/$name.yml"
echo ""
echo "ğŸš€ To start working on this project, run:"
echo "   mise enter"
''']

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’GitHubã«å…¬é–‹
# - local/é…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
# - GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆï¼ˆpublic/privateé¸æŠå¯èƒ½ï¼‰
# - github.com/é…ä¸‹ã«è‡ªå‹•ç§»å‹•
# - tmuxinatorè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹æ›´æ–°
[tasks.publish]
description = "Select a local project and publish it to GitHub"
shell = "bash -lc"
run = ['''
# localé…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
local_projects=$(find $(ghq root)/local -maxdepth 1 -type d -name "*" | sed "s|$(ghq root)/local/||" | grep -v "^$")
if [ -z "$local_projects" ]; then
  echo "âŒ No local projects found"
  exit 1
fi

selected=$(echo "$local_projects" | fzf --prompt="ğŸ“¦ Select local project to publish: ")
if [ -z "$selected" ]; then
  echo "âŒ No project selected"
  exit 1
fi

project_path=$(ghq root)/local/$selected
cd "$project_path"

# GitHubãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
read -p "ğŸ”— GitHub repository name (default: $selected): " repo_name
repo_name=${repo_name:-$selected}

read -p "ğŸ“ Repository description: " description
read -p "ğŸ”“ Make repository public? (y/N): " is_public

if [[ "$is_public" =~ ^[Yy]$ ]]; then
  visibility="--public"
else
  visibility="--private"
fi

# GitHub CLIã§ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
gh repo create "$repo_name" $visibility --description "$description" --source=. --remote=origin --push

# README.mdã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯ã‚’èª­ã¿å–ã£ã¦GitHub Topicsã‚’è¨­å®š
if [ -f "README.md" ]; then
  echo "ğŸ·ï¸  Reading topics from README.md..."
  topics=$(sed -n '/^## Topics/,/^## /p' README.md | grep '^- ' | sed 's/^- //' | grep -v '^$')
  if [ -n "$topics" ]; then
    topic_args=""
    echo "$topics" | while read -r topic; do
      if [ -n "$topic" ]; then
        echo "ğŸ·ï¸  Adding topic: $topic"
        gh repo edit --add-topic "$topic"
      fi
    done
  else
    echo "â„¹ï¸  No topics found in README.md Topics section"
  fi
else
  echo "âš ï¸  README.md not found, skipping topic setup"
fi

# GitHubä¸Šã®ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’å–å¾—
github_user=$(gh api user --jq .login)
github_url="https://github.com/$github_user/$repo_name"

# ghqç®¡ç†ä¸‹ã®github.comãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
github_path=$(ghq root)/github.com/$github_user/$repo_name
mkdir -p "$(dirname "$github_path")"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç§»å‹•
echo "ğŸ“¦ Moving project to GitHub directory..."
mv "$project_path" "$github_path"

# tmuxinatorè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æ›´æ–°
tmux_config="$HOME/.tmuxinator/$selected.yml"
if [ -f "$tmux_config" ]; then
  echo "ğŸ”§ Updating tmuxinator configuration..."
  sed -i.bak "s|root: .*|root: $github_path|" "$tmux_config"
  rm "$tmux_config.bak"
fi

echo "âœ… Repository published to GitHub: $github_url"
echo "ğŸ“ Project moved to: $github_path"
echo "ğŸ”§ Tmuxinator config updated"
echo "ğŸ”— You can now use 'mise enter' to work on this project"
''']

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
# - ghqç®¡ç†ä¸‹ã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºï¼ˆlocal/ã€github.com/ä¸¡æ–¹å«ã‚€ï¼‰
# - é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨tmuxinatorè¨­å®šã‚’å‰Šé™¤
# - è©³ç´°æƒ…å ±è¡¨ç¤ºå¾Œã€ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä»˜ãã§å®‰å…¨ã«å‰Šé™¤
[tasks.delete]
description = "Select and delete a project directory and its tmuxinator config with confirmation"
shell = "bash -lc"
run = ['''
# ghqç®¡ç†ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
projects=$(ghq list)
if [ -z "$projects" ]; then
  echo "âŒ No projects found"
  exit 1
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
selected=$(echo "$projects" | fzf --prompt="ğŸ—‘ï¸  Select project to DELETE: ")
if [ -z "$selected" ]; then
  echo "âŒ No project selected"
  exit 1
fi

project_path=$(ghq root)/$selected
project_name=$(basename "$selected")
readme_path="$project_path/README.md"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è©³ç´°è¡¨ç¤º
echo "ğŸ—‘ï¸  Project Deletion Confirmation"
echo "=================================="
echo "ğŸ“ Project Name: $project_name"
echo "ğŸ“ Directory: $project_path"
echo "ğŸ”§ Tmuxinator Config: ~/.tmuxinator/$project_name.yml"
echo "ğŸŒ Type: $(dirname "$selected" | sed 's|.*/||')"
echo ""

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹è¡¨ç¤º
if [ -d "$project_path" ]; then
  echo "ğŸ“‹ Directory Contents:"
  ls -la "$project_path" | head -10
  file_count=$(find "$project_path" -type f | wc -l)
  echo "   Total files: $file_count"
  echo ""
fi

# Gitæƒ…å ±è¡¨ç¤º
if [ -d "$project_path/.git" ]; then
  echo "ğŸ“Š Git Information:"
  cd "$project_path"
  commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")
  last_commit=$(git log -1 --format="%ar" 2>/dev/null || echo "æœªã‚³ãƒŸãƒƒãƒˆ")
  echo "   Commits: $commit_count"
  echo "   Last commit: $last_commit"
  
  # æœªã‚³ãƒŸãƒƒãƒˆå¤‰æ›´ç¢ºèª
  if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
    echo "   âš ï¸  Uncommitted changes detected!"
    git status --porcelain
  fi
  echo ""
fi

# README.mdæƒ…å ±è¡¨ç¤º
if [ -f "$readme_path" ]; then
  description=$(sed -n '/^## Description/,/^## /p' "$readme_path" | sed '$d' | tail -n +2 | head -3)
  if [ -n "$description" ]; then
    echo "ğŸ“ Project Description:"
    echo "$description"
    echo ""
  fi
fi

echo "âš ï¸  WARNING: This action cannot be undone!"
echo "To confirm deletion, type 'DELETE' (all uppercase):"
read -r confirmation

if [ "$confirmation" != "DELETE" ]; then
  echo "âŒ Deletion cancelled."
  exit 0
fi

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
if [ -d "$project_path" ]; then
  rm -rf "$project_path"
  echo "âœ… Deleted directory: $project_path"
else
  echo "âš ï¸  Directory not found: $project_path"
fi

# tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
if tmux has-session -t "$project_name" 2>/dev/null; then
  tmux kill-session -t "$project_name"
  echo "âœ… Killed tmux session: $project_name"
else
  echo "â„¹ï¸  No active tmux session: $project_name"
fi

# tmuxinatorè¨­å®šå‰Šé™¤
tmux_config="$HOME/.tmuxinator/$project_name.yml"
if [ -f "$tmux_config" ]; then
  rm "$tmux_config"
  echo "âœ… Deleted tmuxinator config: $tmux_config"
else
  echo "âš ï¸  Tmuxinator config not found: $tmux_config"
fi

echo "ğŸ—‘ï¸  Project '$project_name' has been completely removed"
''']

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¨è©³ç´°è¡¨ç¤º
# - ghqç®¡ç†ä¸‹ã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºï¼ˆlocal/ã€github.com/ä¸¡æ–¹å«ã‚€ï¼‰
# - é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®README.mdã‹ã‚‰Descriptionéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
# - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬æƒ…å ±ã‚‚ä½µã›ã¦è¡¨ç¤º
[tasks.info]
description = "List projects and show details of selected project"
shell = "bash -lc"
run = ['''
# ghqç®¡ç†ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
projects=$(ghq list)
if [ -z "$projects" ]; then
  echo "âŒ No projects found"
  exit 1
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
selected=$(echo "$projects" | fzf --prompt="ğŸ“‚ Select project to view details: ")
if [ -z "$selected" ]; then
  echo "âŒ No project selected"
  exit 1
fi

project_path=$(ghq root)/$selected
project_name=$(basename "$selected")
readme_path="$project_path/README.md"

echo "ğŸ“‚ Project: $project_name"
echo "ğŸ“ Location: $project_path"
echo "ğŸŒ Type: $(dirname "$selected" | sed 's|.*/||')"
echo ""

# README.mdã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
if [ -f "$readme_path" ]; then
  echo "ğŸ“„ README.md found:"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # Descriptionéƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆ## Descriptionã‹ã‚‰æ¬¡ã®##ã¾ã§ï¼‰
  description=$(sed -n '/^## Description/,/^## /p' "$readme_path" | sed '$d' | tail -n +2)
  if [ -n "$description" ]; then
    echo "ğŸ“ Description:"
    echo "$description"
  else
    echo "ğŸ“ Description: (æœªè¨˜è¼‰)"
  fi
  
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  # ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ
  if [ -d "$project_path/.git" ]; then
    cd "$project_path"
    commit_count=$(git rev-list --count HEAD 2>/dev/null || echo "0")
    last_commit=$(git log -1 --format="%ar" 2>/dev/null || echo "æœªã‚³ãƒŸãƒƒãƒˆ")
    echo "ğŸ“Š Gitçµ±è¨ˆ:"
    echo "   ã‚³ãƒŸãƒƒãƒˆæ•°: $commit_count"
    echo "   æœ€çµ‚æ›´æ–°: $last_commit"
  fi
else
  echo "ğŸ“„ README.md: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
fi
''']

# æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¨ãƒ³ãƒˆãƒª
# - ghqç®¡ç†ä¸‹ã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºï¼ˆlocal/ã€github.com/ä¸¡æ–¹å«ã‚€ï¼‰
# - é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®tmuxinatorã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
[tasks.enter]
description = "Select an existing ghq project via fzf and start its tmuxinator session"
shell = "bash -lc"
run = ['''
repo=$(ghq list | fzf) && \
name=$(basename "$repo") && \
# Start tmuxinator session for selected project
tmuxinator start "$name"
''']
